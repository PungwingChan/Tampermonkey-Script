// ==UserScript==
// @name         LemeHost æ§åˆ¶é¢æ¿ (å³ä¸Šè§’ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      3.1
// @description  å³ä¸Šè§’æ‚¬æµ®é¢æ¿ï¼ŒDockerç¯å¢ƒä¸“ç”¨ä¼˜åŒ–
// @author       You
// @match        *://lemehost.com/*
// @run-at       document-end
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        threshold: 300, // 5åˆ†é’Ÿ (300ç§’)
        checkInterval: 2000 // 2ç§’æ£€æŸ¥ä¸€æ¬¡
    };
    
    let isAutoEnabled = true;
    let isProcessing = false;

    // ================= UI åˆ›å»ºåŒºåŸŸ =================
    function createPanel() {
        // æ¸…ç†æ—§é¢æ¿
        const oldPanel = document.getElementById('leme-control-panel');
        if (oldPanel) oldPanel.remove();

        const div = document.createElement('div');
        div.id = 'leme-control-panel';
        
        // âœ¨ ä½ç½®è®¾å®šï¼šå³ä¸Šè§’
        div.style.cssText = `
            position: fixed !important;
            top: 60px; /* ç¨å¾®å¾€ä¸‹ä¸€ç‚¹ï¼Œé¿å¼€ç½‘ç«™é¡¶æ  */
            right: 20px;
            width: 250px;
            background: rgba(0, 0, 0, 0.9); /* æ·±è‰²èƒŒæ™¯ */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            font-family: Arial, sans-serif;
            z-index: 2147483647; /* ç¡®ä¿æœ€é¡¶å±‚ */
            font-size: 13px;
            border: 1px solid #555;
            text-align: left;
        `;

        div.innerHTML = `
            <div style="border-bottom: 1px solid #555; padding-bottom: 8px; margin-bottom: 10px; font-weight: bold; color: #4db8ff; display:flex; justify-content:space-between;">
                <span>ğŸš€ LemeHost åŠ©æ‰‹</span>
                <span style="font-size:10px; color:#aaa; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">âœ–</span>
            </div>
            
            <div style="margin-bottom: 5px;">
                <span>â³ å€’è®¡æ—¶: </span>
                <span id="leme-display-time" style="color: #ffcc00; font-weight: bold;">æœç´¢ä¸­...</span>
            </div>
            
            <div style="margin-bottom: 12px;">
                <span>ğŸ“Š çŠ¶æ€: </span>
                <span id="leme-status-text" style="color: #00ff00;">è¿è¡Œæ­£å¸¸</span>
            </div>
            
            <button id="leme-manual-btn" style="
                width: 100%;
                padding: 8px; 
                background: #28a745; 
                border: none; 
                color: white; 
                border-radius: 4px; 
                cursor: pointer;
                font-weight: bold;
                margin-bottom: 10px;">
                âš¡ ç«‹å³ç»­æœŸ
            </button>

            <div>
                <label style="cursor: pointer; user-select: none; display: flex; align-items: center;">
                    <input type="checkbox" id="leme-auto-switch" checked style="margin-right: 6px;"> 
                    è‡ªåŠ¨ç»­æœŸ (< 5åˆ†é’Ÿ)
                </label>
            </div>
        `;

        // å°è¯•æ’å…¥ Body
        if (document.body) {
            document.body.appendChild(div);
        } else {
            // å¦‚æœ Body è¿˜æ²¡å‡ºæ¥ï¼Œç­‰ 1 ç§’å†è¯•
            setTimeout(createPanel, 1000);
            return;
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('leme-manual-btn').addEventListener('click', () => {
            updateStatus('æ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œ...', 'orange');
            executeRenew(true);
        });

        document.getElementById('leme-auto-switch').addEventListener('change', (e) => {
            isAutoEnabled = e.target.checked;
            updateStatus(isAutoEnabled ? 'ç›‘æ§ä¸­...' : 'è‡ªåŠ¨å·²æš‚åœ', isAutoEnabled ? '#00ff00' : '#aaa');
        });
    }

    function updateDisplayTime(text) {
        const el = document.getElementById('leme-display-time');
        if (el) el.innerText = text;
    }

    function updateStatus(text, color) {
        const el = document.getElementById('leme-status-text');
        if (el) {
            el.innerText = text;
            if (color) el.style.color = color;
        }
    }

    // ================= æ ¸å¿ƒé€»è¾‘ =================
    function findRenewButton() {
        const buttons = document.getElementsByTagName('button');
        for (let btn of buttons) {
            if (btn.type === 'submit' && btn.innerText.includes('Extend time')) {
                return btn;
            }
        }
        return null;
    }

    function parseTime(timeStr) {
        if (!timeStr) return 99999;
        const parts = timeStr.trim().split(':').map(Number);
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        return 99999;
    }

    function executeRenew(isManual = false) {
        if (isProcessing && !isManual) return;

        const btn = findRenewButton();
        if (!btn) {
            updateStatus('âŒ æœªæ‰¾åˆ°é¡µé¢æŒ‰é’®', 'red');
            return;
        }

        isProcessing = true;
        
        // è§†è§‰åé¦ˆ
        const originalText = btn.innerText;
        btn.style.backgroundColor = '#ff4444';
        btn.innerText = 'è„šæœ¬ç‚¹å‡»ä¸­...';
        updateStatus('âš¡ æ­£åœ¨ç‚¹å‡»...', 'orange');

        setTimeout(() => {
            btn.click();
            updateStatus('âœ… ç‚¹å‡»å®Œæˆ', '#00ff00');
            
            // ç‚¹å‡»åç­‰å¾…åˆ·æ–°
            setTimeout(() => { 
                isProcessing = false; 
                try { btn.innerText = originalText; } catch(e){}
                updateStatus('ç›‘æ§ä¸­...', '#00ff00');
            }, 5000);
        }, 500);
    }

    function mainLoop() {
        const timerSpan = document.getElementById('countdown-free-plan');
        if (!timerSpan) {
            updateDisplayTime('æœªæ£€æµ‹åˆ°');
            return;
        }
        const timeText = timerSpan.innerText.trim();
        updateDisplayTime(timeText);

        if (!isAutoEnabled) return;

        const remainingSeconds = parseTime(timeText);
        if (remainingSeconds < CONFIG.threshold && remainingSeconds > 0) {
            executeRenew(false);
        }
    }

    // ================= å¯åŠ¨ =================
    setTimeout(() => {
        createPanel();
        setInterval(mainLoop, CONFIG.checkInterval);
    }, 2000);

})();
