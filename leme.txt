// ==UserScript==
// @name         LemeHost å¼ºåŠ›æ§åˆ¶é¢æ¿ (å¸¦æ‰‹åŠ¨è§¦å‘)
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  å³ä¸‹è§’æ‚¬æµ®é¢æ¿ï¼Œæ”¯æŒæ‰‹åŠ¨ç‚¹å‡»ç»­æœŸã€è‡ªåŠ¨ç›‘æ§å¼€å…³ã€å®æ—¶çŠ¶æ€æ˜¾ç¤º
// @author       You
// @match        https://lemehost.com/server/*/free-plan*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=lemehost.com
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        threshold: 300, // é˜ˆå€¼ï¼š5åˆ†é’Ÿ (300ç§’)
        checkInterval: 2000 // æ£€æŸ¥é¢‘ç‡ï¼š2ç§’
    };
    
    // çŠ¶æ€å˜é‡
    let isAutoEnabled = true; // é»˜è®¤å¼€å¯è‡ªåŠ¨
    let isProcessing = false; // æ˜¯å¦æ­£åœ¨å¤„ç†ä¸­

    // ================= UI åˆ›å»ºåŒºåŸŸ =================
    function createPanel() {
        const div = document.createElement('div');
        div.id = 'leme-control-panel';
        div.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 260px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-family: Arial, sans-serif;
            z-index: 99999;
            font-size: 14px;
            border: 1px solid #444;
        `;

        div.innerHTML = `
            <div style="border-bottom: 1px solid #555; padding-bottom: 8px; margin-bottom: 10px; font-weight: bold; color: #4db8ff;">
                ğŸš€ LemeHost æ§åˆ¶å°
            </div>
            <div style="margin-bottom: 5px;">
                <span>â³ é¡µé¢å€’è®¡æ—¶: </span>
                <span id="leme-display-time" style="color: #ffcc00; font-weight: bold;">--:--:--</span>
            </div>
            <div style="margin-bottom: 15px;">
                <span>ğŸ“Š è„šæœ¬çŠ¶æ€: </span>
                <span id="leme-status-text" style="color: #00ff00;">ç›‘æ§ä¸­...</span>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="leme-manual-btn" style="
                    flex: 1; 
                    padding: 8px; 
                    background: #28a745; 
                    border: none; 
                    color: white; 
                    border-radius: 4px; 
                    cursor: pointer;
                    font-weight: bold;">
                    âš¡ ç«‹å³ç»­æœŸ
                </button>
            </div>

            <div style="margin-top: 5px;">
                <label style="cursor: pointer; user-select: none;">
                    <input type="checkbox" id="leme-auto-switch" checked> å¯ç”¨è‡ªåŠ¨ç»­æœŸ (< 5åˆ†é’Ÿ)
                </label>
            </div>
        `;

        document.body.appendChild(div);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('leme-manual-btn').addEventListener('click', () => {
            updateStatus('æ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œ...', 'orange');
            executeRenew(true); // ä¼ å…¥ true è¡¨ç¤ºæ‰‹åŠ¨å¼ºåˆ¶
        });

        document.getElementById('leme-auto-switch').addEventListener('change', (e) => {
            isAutoEnabled = e.target.checked;
            updateStatus(isAutoEnabled ? 'ç›‘æ§ä¸­...' : 'è‡ªåŠ¨å·²æš‚åœ', isAutoEnabled ? '#00ff00' : '#aaa');
        });
    }

    // æ›´æ–°é¢æ¿æ˜¾ç¤ºçš„æ–‡å­—
    function updateDisplayTime(text) {
        const el = document.getElementById('leme-display-time');
        if (el) el.innerText = text;
    }

    function updateStatus(text, color) {
        const el = document.getElementById('leme-status-text');
        if (el) {
            el.innerText = text;
            if (color) el.style.color = color;
        }
    }

    // ================= æ ¸å¿ƒé€»è¾‘åŒºåŸŸ =================

    // 1. æŸ¥æ‰¾æŒ‰é’®
    function findRenewButton() {
        const buttons = document.getElementsByTagName('button');
        for (let btn of buttons) {
            // åŒ¹é… type="submit" ä¸”åŒ…å« Extend time æ–‡å­—
            if (btn.type === 'submit' && btn.innerText.includes('Extend time')) {
                return btn;
            }
        }
        return null;
    }

    // 2. è§£ææ—¶é—´
    function parseTime(timeStr) {
        if (!timeStr) return 99999;
        const parts = timeStr.trim().split(':').map(Number);
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        return 99999;
    }

    // 3. æ‰§è¡Œç»­æœŸåŠ¨ä½œ
    function executeRenew(isManual = false) {
        if (isProcessing && !isManual) return; // å¦‚æœæ­£åœ¨å¤„ç†ä¸”éæ‰‹åŠ¨ï¼Œåˆ™è·³è¿‡

        const btn = findRenewButton();
        if (!btn) {
            updateStatus('âŒ æœªæ‰¾åˆ°æŒ‰é’®!', 'red');
            console.error('LemeHost è„šæœ¬: æœªæ‰¾åˆ°ç»­æœŸæŒ‰é’®');
            return;
        }

        isProcessing = true;
        
        // è§†è§‰åé¦ˆ
        btn.style.backgroundColor = '#ff4444';
        btn.innerText = 'è„šæœ¬ç‚¹å‡»ä¸­...';
        updateStatus('âš¡ æ­£åœ¨ç‚¹å‡»...', 'orange');

        // ç‚¹å‡»
        setTimeout(() => {
            btn.click();
            console.log('âœ… å·²è§¦å‘ç‚¹å‡»äº‹ä»¶');
            updateStatus('âœ… ç‚¹å‡»å®Œæˆï¼Œç­‰å¾…åˆ·æ–°', '#00ff00');
            
            // 5ç§’åé‡ç½®çŠ¶æ€ï¼ˆå¦‚æœé¡µé¢æ²¡åˆ·æ–°çš„è¯ï¼‰
            setTimeout(() => { 
                isProcessing = false; 
                if(!isAutoEnabled) updateStatus('è‡ªåŠ¨å·²æš‚åœ', '#aaa');
                else updateStatus('ç›‘æ§ä¸­...', '#00ff00');
            }, 5000);
        }, 500);
    }

    // 4. ä¸»å¾ªç¯
    function mainLoop() {
        // è·å–å€’è®¡æ—¶ DOM
        const timerSpan = document.getElementById('countdown-free-plan');
        
        if (!timerSpan) {
            updateDisplayTime('æœªæ£€æµ‹åˆ°å€’è®¡æ—¶');
            return;
        }

        const timeText = timerSpan.innerText.trim();
        updateDisplayTime(timeText); // æ›´æ–°é¢æ¿æ—¶é—´æ˜¾ç¤º

        // å¦‚æœè‡ªåŠ¨åŠŸèƒ½å…³é—­ï¼Œåˆ™ä¸æ‰§è¡Œåç»­åˆ¤æ–­
        if (!isAutoEnabled) return;

        const remainingSeconds = parseTime(timeText);
        
        // åˆ¤æ–­é˜ˆå€¼
        if (remainingSeconds < CONFIG.threshold && remainingSeconds > 0) {
            console.log(`â±ï¸ è§¦å‘è‡ªåŠ¨ç»­æœŸ! å‰©ä½™: ${remainingSeconds}ç§’`);
            executeRenew(false); // è‡ªåŠ¨æ‰§è¡Œ
        }
    }

    // ================= å¯åŠ¨ =================
    // ç­‰å¾…é¡µé¢åŠ è½½ä¸€å°ä¼šå„¿å†æ˜¾ç¤ºé¢æ¿
    setTimeout(() => {
        createPanel();
        // å¯åŠ¨å¾ªç¯
        setInterval(mainLoop, CONFIG.checkInterval);
    }, 1500);

})();
