// ==UserScript==
// @name         LemeHost Dockerä¸“ç”¨é¢æ¿ (å·¦ä¸Šè§’ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  å°†é¢æ¿ç§»è‡³å·¦ä¸Šè§’ï¼Œé˜²æ­¢åœ¨Docker/VNCç¯å¢ƒä¸­è¢«é®æŒ¡
// @author       You
// @match        https://lemehost.com/server/*/free-plan*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=lemehost.com
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        threshold: 300, // 5åˆ†é’Ÿ
        checkInterval: 2000 // 2ç§’æ£€æŸ¥ä¸€æ¬¡
    };
    
    let isAutoEnabled = true;
    let isProcessing = false;

    // ================= UI åˆ›å»ºåŒºåŸŸ (CSS å·²ä¿®æ”¹) =================
    function createPanel() {
        // å…ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§é¢æ¿ï¼ˆé˜²æ­¢é‡å¤ï¼‰
        const oldPanel = document.getElementById('leme-control-panel');
        if (oldPanel) oldPanel.remove();

        const div = document.createElement('div');
        div.id = 'leme-control-panel';
        
        // âš ï¸ ä¿®æ”¹ç‚¹ï¼šæ”¹ä¸ºå·¦ä¸Šè§’ï¼ŒèƒŒæ™¯è‰²åŠ æ·±ï¼Œå±‚çº§è°ƒåˆ°æœ€é«˜
        div.style.cssText = `
            position: fixed !important;
            top: 10px;
            left: 10px;
            width: 240px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
            font-family: sans-serif;
            z-index: 2147483647; /* æœ€å¤§çš„ Z-Index */
            font-size: 13px;
            border: 2px solid #00ff00; /* åŠ ä¸ªç»¿æ¡†è®©ä½ æ›´å®¹æ˜“çœ‹è§ */
        `;

        div.innerHTML = `
            <div style="border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 8px; font-weight: bold; color: #4db8ff;">
                ğŸš€ LemeHost é¢æ¿ (Dockerç‰ˆ)
            </div>
            <div style="margin-bottom: 5px;">
                <span>â³ å€’è®¡æ—¶: </span>
                <span id="leme-display-time" style="color: #ffcc00; font-weight: bold;">æ£€æµ‹ä¸­...</span>
            </div>
            <div style="margin-bottom: 10px;">
                <span>ğŸ“Š çŠ¶æ€: </span>
                <span id="leme-status-text" style="color: #00ff00;">å¯åŠ¨ä¸­</span>
            </div>
            
            <button id="leme-manual-btn" style="
                width: 100%;
                padding: 6px; 
                background: #28a745; 
                border: none; 
                color: white; 
                border-radius: 3px; 
                cursor: pointer;
                font-weight: bold;
                margin-bottom: 8px;">
                âš¡ ç«‹å³æ‰‹åŠ¨ç»­æœŸ
            </button>

            <div>
                <label style="cursor: pointer; user-select: none;">
                    <input type="checkbox" id="leme-auto-switch" checked> å¼€å¯è‡ªåŠ¨ç»­æœŸ
                </label>
            </div>
        `;

        document.body.appendChild(div);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('leme-manual-btn').addEventListener('click', () => {
            updateStatus('æ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œ...', 'orange');
            executeRenew(true);
        });

        document.getElementById('leme-auto-switch').addEventListener('change', (e) => {
            isAutoEnabled = e.target.checked;
            updateStatus(isAutoEnabled ? 'ç›‘æ§ä¸­...' : 'è‡ªåŠ¨å·²æš‚åœ', isAutoEnabled ? '#00ff00' : '#aaa');
        });
    }

    function updateDisplayTime(text) {
        const el = document.getElementById('leme-display-time');
        if (el) el.innerText = text;
    }

    function updateStatus(text, color) {
        const el = document.getElementById('leme-status-text');
        if (el) {
            el.innerText = text;
            if (color) el.style.color = color;
        }
    }

    // ================= æ ¸å¿ƒé€»è¾‘ =================
    function findRenewButton() {
        const buttons = document.getElementsByTagName('button');
        for (let btn of buttons) {
            if (btn.type === 'submit' && btn.innerText.includes('Extend time')) {
                return btn;
            }
        }
        return null;
    }

    function parseTime(timeStr) {
        if (!timeStr) return 99999;
        const parts = timeStr.trim().split(':').map(Number);
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        return 99999;
    }

    function executeRenew(isManual = false) {
        if (isProcessing && !isManual) return;

        const btn = findRenewButton();
        if (!btn) {
            updateStatus('âŒ æ²¡æ‰¾åˆ°æŒ‰é’®!', 'red');
            return;
        }

        isProcessing = true;
        btn.style.backgroundColor = '#ff4444';
        btn.innerText = 'ç‚¹å‡»ä¸­...';
        updateStatus('âš¡ æ­£åœ¨ç‚¹å‡»...', 'orange');

        setTimeout(() => {
            btn.click();
            updateStatus('âœ… ç‚¹å‡»å®Œæˆ', '#00ff00');
            setTimeout(() => { 
                isProcessing = false; 
                updateStatus('ç›‘æ§ä¸­...', '#00ff00');
            }, 5000);
        }, 500);
    }

    function mainLoop() {
        const timerSpan = document.getElementById('countdown-free-plan');
        if (!timerSpan) {
            updateDisplayTime('æœªæ‰¾åˆ°å€’è®¡æ—¶');
            return;
        }
        const timeText = timerSpan.innerText.trim();
        updateDisplayTime(timeText);

        if (!isAutoEnabled) return;

        const remainingSeconds = parseTime(timeText);
        if (remainingSeconds < CONFIG.threshold && remainingSeconds > 0) {
            executeRenew(false);
        }
    }

    setTimeout(() => {
        createPanel();
        setInterval(mainLoop, CONFIG.checkInterval);
    }, 2000);

})();
