// ==UserScript==
// @name         LemeHost æ§åˆ¶é¢æ¿ (å³ä¸‹è§’ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      2.2
// @description  å³ä¸‹è§’æ‚¬æµ®é¢æ¿ï¼Œæ”¯æŒæ‰‹åŠ¨ç‚¹å‡»ç»­æœŸã€è‡ªåŠ¨ç›‘æ§å¼€å…³ã€å®æ—¶çŠ¶æ€æ˜¾ç¤º
// @author       You
// @match        https://lemehost.com/server/*/free-plan*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=lemehost.com
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        threshold: 300, // é˜ˆå€¼ï¼š5åˆ†é’Ÿ (300ç§’)
        checkInterval: 2000 // æ£€æŸ¥é¢‘ç‡ï¼š2ç§’
    };
    
    // çŠ¶æ€å˜é‡
    let isAutoEnabled = true; // é»˜è®¤å¼€å¯è‡ªåŠ¨
    let isProcessing = false; // æ˜¯å¦æ­£åœ¨å¤„ç†ä¸­

    // ================= UI åˆ›å»ºåŒºåŸŸ =================
    function createPanel() {
        // åˆ é™¤æ—§é¢æ¿ï¼ˆé˜²æ­¢é‡å¤ï¼‰
        const oldPanel = document.getElementById('leme-control-panel');
        if (oldPanel) oldPanel.remove();

        const div = document.createElement('div');
        div.id = 'leme-control-panel';
        
        // âœ¨ è¿™é‡Œæ”¹å›äº†å³ä¸‹è§’
        div.style.cssText = `
            position: fixed !important;
            bottom: 20px;
            right: 20px;
            width: 260px;
            background: rgba(0, 0, 0, 0.85); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-family: Arial, sans-serif;
            z-index: 2147483647; /* ä¿æŒæœ€é¡¶å±‚ï¼Œé˜²é®æŒ¡ */
            font-size: 14px;
            border: 1px solid #444;
        `;

        div.innerHTML = `
            <div style="border-bottom: 1px solid #555; padding-bottom: 8px; margin-bottom: 10px; font-weight: bold; color: #4db8ff;">
                ğŸš€ LemeHost æ§åˆ¶å°
            </div>
            <div style="margin-bottom: 5px;">
                <span>â³ å€’è®¡æ—¶: </span>
                <span id="leme-display-time" style="color: #ffcc00; font-weight: bold;">æ£€æµ‹ä¸­...</span>
            </div>
            <div style="margin-bottom: 15px;">
                <span>ğŸ“Š çŠ¶æ€: </span>
                <span id="leme-status-text" style="color: #00ff00;">ç›‘æ§ä¸­...</span>
            </div>
            
            <button id="leme-manual-btn" style="
                width: 100%;
                padding: 10px; 
                background: #28a745; 
                border: none; 
                color: white; 
                border-radius: 4px; 
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 10px;">
                âš¡ ç«‹å³æ‰‹åŠ¨ç»­æœŸ
            </button>

            <div style="margin-top: 5px; font-size: 13px;">
                <label style="cursor: pointer; user-select: none; display: flex; align-items: center;">
                    <input type="checkbox" id="leme-auto-switch" checked style="margin-right: 6px;"> 
                    å¯ç”¨è‡ªåŠ¨ç»­æœŸ (< 5åˆ†é’Ÿ)
                </label>
            </div>
        `;

        document.body.appendChild(div);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('leme-manual-btn').addEventListener('click', () => {
            updateStatus('æ­£åœ¨æ‰‹åŠ¨æ‰§è¡Œ...', 'orange');
            executeRenew(true); // ä¼ å…¥ true è¡¨ç¤ºæ‰‹åŠ¨å¼ºåˆ¶
        });

        document.getElementById('leme-auto-switch').addEventListener('change', (e) => {
            isAutoEnabled = e.target.checked;
            updateStatus(isAutoEnabled ? 'ç›‘æ§ä¸­...' : 'è‡ªåŠ¨å·²æš‚åœ', isAutoEnabled ? '#00ff00' : '#aaa');
        });
    }

    // æ›´æ–°é¢æ¿æ˜¾ç¤ºçš„æ–‡å­—
    function updateDisplayTime(text) {
        const el = document.getElementById('leme-display-time');
        if (el) el.innerText = text;
    }

    function updateStatus(text, color) {
        const el = document.getElementById('leme-status-text');
        if (el) {
            el.innerText = text;
            if (color) el.style.color = color;
        }
    }

    // ================= æ ¸å¿ƒé€»è¾‘åŒºåŸŸ =================

    // 1. æŸ¥æ‰¾æŒ‰é’®
    function findRenewButton() {
        const buttons = document.getElementsByTagName('button');
        for (let btn of buttons) {
            // åŒ¹é… type="submit" ä¸”åŒ…å« Extend time æ–‡å­—
            if (btn.type === 'submit' && btn.innerText.includes('Extend time')) {
                return btn;
            }
        }
        return null;
    }

    // 2. è§£ææ—¶é—´
    function parseTime(timeStr) {
        if (!timeStr) return 99999;
        const parts = timeStr.trim().split(':').map(Number);
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        return 99999;
    }

    // 3. æ‰§è¡Œç»­æœŸåŠ¨ä½œ
    function executeRenew(isManual = false) {
        if (isProcessing && !isManual) return; // å¦‚æœæ­£åœ¨å¤„ç†ä¸”éæ‰‹åŠ¨ï¼Œåˆ™è·³è¿‡

        const btn = findRenewButton();
        if (!btn) {
            updateStatus('âŒ æœªæ‰¾åˆ°æŒ‰é’®!', 'red');
            console.error('LemeHost è„šæœ¬: æœªæ‰¾åˆ°ç»­æœŸæŒ‰é’®');
            return;
        }

        isProcessing = true;
        
        // è§†è§‰åé¦ˆ
        const originalText = btn.innerText;
        const originalColor = btn.style.backgroundColor;
        
        btn.style.backgroundColor = '#ff4444';
        btn.innerText = 'è„šæœ¬å¤„ç†ä¸­...';
        updateStatus('âš¡ æ­£åœ¨ç‚¹å‡»...', 'orange');

        // ç‚¹å‡»
        setTimeout(() => {
            btn.click();
            console.log('âœ… å·²è§¦å‘ç‚¹å‡»äº‹ä»¶');
            updateStatus('âœ… ç‚¹å‡»å®Œæˆ', '#00ff00');
            
            // 5ç§’åé‡ç½®çŠ¶æ€
            setTimeout(() => { 
                isProcessing = false; 
                // æ¢å¤æŒ‰é’®æ ·å¼ï¼ˆå¦‚æœé¡µé¢æ²¡åˆ·æ–°çš„è¯ï¼‰
                try {
                    btn.style.backgroundColor = originalColor;
                    btn.innerText = originalText;
                } catch(e) {}
                
                if(!isAutoEnabled) updateStatus('è‡ªåŠ¨å·²æš‚åœ', '#aaa');
                else updateStatus('ç›‘æ§ä¸­...', '#00ff00');
            }, 5000);
        }, 500);
    }

    // 4. ä¸»å¾ªç¯
    function mainLoop() {
        const timerSpan = document.getElementById('countdown-free-plan');
        
        if (!timerSpan) {
            updateDisplayTime('æœªæ£€æµ‹åˆ°å€’è®¡æ—¶');
            return;
        }

        const timeText = timerSpan.innerText.trim();
        updateDisplayTime(timeText); // æ›´æ–°é¢æ¿æ—¶é—´æ˜¾ç¤º

        if (!isAutoEnabled) return;

        const remainingSeconds = parseTime(timeText);
        
        if (remainingSeconds < CONFIG.threshold && remainingSeconds > 0) {
            console.log(`â±ï¸ è§¦å‘è‡ªåŠ¨ç»­æœŸ! å‰©ä½™: ${remainingSeconds}ç§’`);
            executeRenew(false); 
        }
    }

    // ================= å¯åŠ¨ =================
    setTimeout(() => {
        createPanel();
        setInterval(mainLoop, CONFIG.checkInterval);
    }, 2000);

})();
